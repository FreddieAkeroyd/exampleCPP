<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
  <title>EPICS exampleCPP/exampleLink</title>
  <link rel="stylesheet" type="text/css"
  href="http://epics-pvdata.sourceforge.net/base.css" />
  <link rel="stylesheet" type="text/css"
  href="http://epics-pvdata.sourceforge.net/epicsv4.css" />
  <style type="text/css">
/*<![CDATA[*/
     .about { margin-left: 3em; margin-right: 3em; font-size: .83em}
     table { margin-left: auto; margin-right: auto }
     .diagram { text-align: center; margin: 2.5em 0 }
     body { margin-right: 10% }
/*]]>*/</style>

 <!-- Script that generates the Table of Contents -->
  <script type="text/javascript" src="http://epics-pvdata.sourceforge.net/script/tocgen.js"></script>

</head>

<body>

<div class="head">
<h1>EPICS exampleCPP/exampleLink</h1>
<h2 class="nocount">Release 1.0 - 2016.03.10</h2>

<h2 class="nocount">Abstract</h2>
<p>
<b>exampleLink</b> implements a PVRecord that uses pvAccess to access another channel.
</p>
  <!-- last para of Abstract is boilerplate reference to EPICS -->
      <p>For more information about EPICS generally, please refer to the home page of the <a
       href="http://www.aps.anl.gov/epics/">Experimental Physics and Industrial
      Control System</a>.</p>


</div> <!-- head -->

<div id="toc">
  <h2 class="nocount">Table of Contents</h2>
</div>

<!-- Place what you would like in the Table of Contents, inside the contents div -->
<div id="contents" class="contents">	  
<hr />

<h2>Overview</h2>
<p>This example shows how a PVRecord can have support that accesses other channel.</p>
<p><b>exampleLink</b> can be started either as a main program of as part of an EPICS V3 IOC.</p>
<h3>Start as a main program</h3>
<pre>
mrk> pwd
/home/epicsv4/master/exampleCPP/exampleLink
mrk> bin/$EPICS_HOST_ARCH/exampleLinkMain provider
</pre>
<p><b>provider</b> is optional.
If specified it must be <b>local</b> or <b>pva</b>.
The default is <b>pva</b>.
</p>
<h3>Start it as part of an EPICS V3 IOC:</h3>
<pre>
mrk> pwd
/home/epicsv4/master/exampleCPP/exampleLink/iocBoot/exampleLink
mrk> ../../bin/$EPICS_HOST_ARCH/exampleLink arg
</pre>
<p><b>arg</b> must be either <b>st.local</b> or <b>st.remote</b>
</p>
<h3>exampleLinkClient</h3>
<p>A pvaClient test is available to test exampleLink.
Start the example and then:</p>
<pre>
mrk> pwd
/home/epicsv4/master/exampleCPP/exampleLink
mrk> bin/$EPICS_HOST_ARCH/exampleLinkClient
</pre>
<h2>Discussion</h2>
<h3>Access Alternatives</h3>
<p>The process routine of a PVRecord can access other PVRecords in two ways:</p>
<dl>
  <dt>Directly accessing local pvDatabase</dt>
    <dd>
    If the other PVRecord is accessed via the master PVDatabase then
    threading issues are up to the implementation.
    </dd>
  <dt>Access via channelProvider pva or ca</dt>
    <dd>
      If  provider  <b>pva</b> or <b>ca</b> is used then locking is handled by pvAccess.</dd>
  <dt>Access via channelProvider local</dt>
    <dd>
    If provider  <b>local</b> is used the implementation must be careful that it does not
    cause deadlocks.
    When the process method is called the pvRecord for the process method is locked.
    When it makes a pvAccess get, put, etc request the other record is locked.
    Thus if a set of pvAccess links are implemented the possibility of deadlocks
    exists. A simple example is two records that have links to each other.
    More complex sets are easily created.
    Unless the developer has complete control of the set of records then remote pvAccess should
    be used.
    But this results in more context switches.
    </dd>
</dl>
<h3>Data synchronization</h3>
<p>If pvAccess (provider  <b>pva</b> or <b>ca</b>) is used then it handles data synchronization.
This is done by making a copy of the data that is transferred between the two pvRecords.
This is true if either remote or local pvAccess is used.
Each get, put, etc request results in data being copied between the two records.</p>
<p>
If the linked channel is a local pvRecord then,
for scalar and structure arrays,
raw data is NOT copied for gets.
This is because pvData uses shared_vector to hold the raw data.
Instead of copying the raw data the reference count is incremented.</p>
<p>For puts the linked array will force a new allocation of the raw data in the linked record,
i. e. copy on write semantics are enforced. This is done automatically
by pvData and not by pvDatabase.</p>
<h3>Some details</h3>
<p>As mentioned before a pvDatabase server can be either a separate process,
i. e. a main program, or can be part of a V3IOC.</p>
<p>A main pvDatabase server issues the following calls:</p>
<pre>
...
    PVDatabasePtr master = PVDatabase::getMaster();
    ChannelProviderLocalPtr channelProvider = getChannelProviderLocal();
    ServerContext::shared_pointer ctx =
    startPVAServer(PVACCESS_ALL_PROVIDERS,0,true,true);
    PvaClientPtr pva= PvaClient::create();
... 
    master->addRecord(...
...
   cout << "exampleLink\n";
   string str;
   while(true) {
        cout << "Type exit to stop: \n";
        getline(cin,str);
        if(str.compare("exit")==0) break;
   }
...
</pre>
<p><b>PvaClientPtr pva= PvaClient::create()</b> is only necessary if some of the pvRecords
have <b>pva</b> or <b>ca</b> links.
These must be called before any code that uses links is initialized.
</p>
<p>A pvDatabase that is part of a V3IOC has the following in the st.cmd file.</p>
<pre>
...
iocInit()
startPVAClient
startPVAServer
## commands to create pvRecords
</pre>
<h2>Using exampleLinkMain to test providers local pva and ca</h2>
<h3>Options</h3>
<p>The options supported by exampleLinkMain are shown by:</p>
<pre>
mrk> pwd
/home/epicsv4/master/exampleCPP/exampleLink
mrk> bin/linux-x86_64/exampleLinkMain -help
provider exampleLinkRecordName . generateLinkedRecord
default
pva exampleLink doubleArray true
mrk> 
</pre>
<p>
Thus to run it with default options:
</p>
<pre>
bin/linux-x86_64/exampleLinkMain 
</pre>
<p>exampleLinkMain creates an instance of ExampleLinkRecord.
The record name is <b>exampleLinkRecordName</b>.
The ExampleLinkRecord monitors <b>linkedRecordName</b> using the specified <b>provider</b>.
</p>
<h3>Monitor exampleLink</h3>
<p>After exampleLinkMain is started then in another window:<p>
<pre>
pvget -m -r "field()" exampleLink
</pre>
<p>This can be kept running while exampleLinkMain is stopped and then restarted with
other options as long as <b>exampleLinkRecordName</b> is doubleArray.
</p>
<h3>exampleLinkClient</h3>
<p>This makes changes to the record that exampleLink monitors.
It has the options:
</p>
<pre>
mrk> pwd
/home/epicsv4/master/exampleCPP/exampleLink
mrk> bin/linux-x86_64/exampleLinkClient -help
provider
default
pva
</pre>
<p><b>NOTE:</b> If exampleLinkMain is stated with provider <b>ca</b>
then exampleLinkClient must also be run with provider <b>ca</b>
</p>

<p>exampleLinkClient only works if <b>linkedRecordName</b> is doubleArray.
</p>
<h3>Testing via provider local</h3>
<p>This can be tested via:</p>
<pre>
bin/linux-x86_64/exampleLinkMain local 
</pre>
<h3>Testing via provider pva</h3>
<p>This can be done via the default options:</p>
<pre>
bin/linux-x86_64/exampleLinkMain 
</pre>

<p>It can also be run with pva accessing a record in another IOC:</p>
<pre>
bin/linux-x86_64/exampleLinkMain pva exampleLink doubleArray  false
</pre>
<p>But this only starts running when the following is also started:</p>
<pre>
mrk> pwd
/home/epicsv4/master/exampleCPP/exampleLink
mrk> bin/linux-x86_64/doubleArrayMain 
</pre>
<p><b>NOTE</b> do not leave this running for other exampleLinkMain options.
</p>
<h3>Testing via provider ca</h3>
<p>This can be tested as follows:</p>
<pre>
bin/linux-x86_64/exampleLinkMain ca exampleLink doubleArray  false
</pre>

<p>But a softIoc for record doubleArray must also be started:</p>
<pre>
mrk> pwd
/home/epicsv4/master/exampleCPP/exampleLink/v3IOC
mrk> softIoc st.cmd
</pre>


<h2>Directory Layout</h2>
<pre>
exampleLink
    configure
       ExampleRELEASE.local
       ...
    src
       pv
          exampleLinkRecord.h
       exampleLinkRecord.cpp
       exampleLinkInclude.dbd
       exampleLinkRegister.cpp
       exampleLinkClient.cpp
       exampleLinkMain.cpp
       doubleArrayMain.cpp
    ioc
       Db
       src
          exampleLinkInclude.dbd
          exampleLinkMain.cpp
    iocBoot
        exampleLink
           st.local
           st.remote
    v3IOC
        db
            doubleArray.db
        st.cmd
        README
         ...
</pre>



<h3>exampleLinkRegister.dbd and exampleLinkRegister.cpp</h3>
<p>This is the code that supports the <b>exampleLinkCreateRecord</b>
        shell command in <b>exampleLink/iocBoot/exampleLink/st.*</b>.
</p>
<p>The following is from <b>exampleLinkRegister.cpp</b>
</p>
<pre>
static void exampleLinkCallFunc(const iocshArgBuf *args)
{
    PVDatabasePtr master = PVDatabase::getMaster();
    PVRecordPtr pvRecord;
    bool result(false);
    string recordName;
    NTScalarArrayBuilderPtr ntScalarArrayBuilder = NTScalarArray::createBuilder();
    PVStructurePtr pvStructure = ntScalarArrayBuilder->
        value(pvDouble)->
        addAlarm()->
        addTimeStamp()->
        createPVStructure();
    result = master->addRecord(PVRecord::create("doubleArray",pvStructure));
    if(!result) cout<< "record " << recordName << " not added" << endl;

    recordName = args[0].sval;
    char *providerName = args[1].sval;
    char *channelName = args[2].sval;
    ExampleLinkRecordPtr record = ExampleLinkRecord::create(recordName,providerName,channelName);
    if(record) 
        result = master->addRecord(record);
    if(!result) cout << "recordname" << " not added" << endl;
}
</pre>
<p>Note that this is similar to the code in <b>exampleLinkMain.cpp</b>
</p>
<h2>exampleLink/ioc</h2>
<p>This is standard way to create support for a V3 IOC.
</p>
<h3>exampleLink/ioc/Db</h3>
<p>This is used by the example to create a DBRecord named exampleLinkAI
</p>
<h3>exampleLink/ioc/src</h3>
<p><b>exampleLinkInclude.dbd</b></p>
<pre>
include "base.dbd"
include "PVAServerRegister.dbd"
include "PVAClientRegister.dbd"
include "registerChannelProviderLocal.dbd"
include "exampleLinkRegister.dbd"
</pre>
<p>Has V3 IOC includes for the example</p>
<p><b>exampleLinkMain.cpp</b>  is standard V3 IOC code.</p>
<h2>exampleLink/iocBoot/exampleLink</h2>
<p>This is where a V3 IOC that includes <b>exampleLink</b> is started.
It has two startup files.
<b>st.local</b> is:</p>
<pre>
< envPaths
cd ${TOP}
## Register all support components
dbLoadDatabase("dbd/exampleLink.dbd")
exampleLink_registerRecordDeviceDriver(pdbbase)

## Load record instance
dbLoadRecords("db/ai.db","name=exampleLinkAI");

cd ${TOP}/iocBoot/${IOC}
iocInit()
startPVAServer
exampleLinkCreateRecord exampleLink local doubleArray
</pre>
<p><b>st.remote</b> is the similar except that it asks for provider pva instead of local.
It also issues iocsh command <b>startPVAClient</b></p>
</div> <!-- class="contents" -->
</body>
</html>
